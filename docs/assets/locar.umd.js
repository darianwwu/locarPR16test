(function(a,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],n):(a=typeof globalThis<"u"?globalThis:a||self,n(a.locar={},a.THREE))})(this,function(a,n){"use strict";var G=a=>{throw TypeError(a)};var W=(a,n,m)=>n.has(a)||G("Cannot "+m);var r=(a,n,m)=>(W(a,n,"read from private field"),m?m.call(a):n.get(a)),O=(a,n,m)=>n.has(a)?G("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(a):n.set(a,m),g=(a,n,m,f)=>(W(a,n,"write to private field"),f?f.call(a,m):n.set(a,m),m),P=(a,n,m)=>(W(a,n,"access private method"),m);var Y=(a,n,m,f)=>({set _(q){g(a,n,q,m)},get _(){return r(a,n,f)}});var A,Q,X,Z,B,R,U,_,S,N,b,I,T,D,E,M,k,K,V,J;function m(w){const o=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(w){for(const e in w)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(w,e);Object.defineProperty(o,e,t.get?t:{enumerable:!0,get:()=>w[e]})}}return o.default=w,Object.freeze(o)}const f=m(n);class q{constructor(){O(this,A);this.EARTH=4007501668e-2,this.HALF_EARTH=2003750834e-2}project(o,e){return[P(this,A,Q).call(this,o),P(this,A,X).call(this,e)]}unproject(o){return[P(this,A,Z).call(this,o[0]),P(this,A,B).call(this,o[1])]}getID(){return"epsg:3857"}}A=new WeakSet,Q=function(o){return o/180*this.HALF_EARTH},X=function(o){var e=Math.log(Math.tan((90+o)*Math.PI/360))/(Math.PI/180);return e*this.HALF_EARTH/180},Z=function(o){return o/this.HALF_EARTH*180},B=function(o){var e=o/this.HALF_EARTH*180;return e=180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2),e};class H{constructor(){this.eventHandlers={}}on(o,e){this.eventHandlers[o]=e}emit(o,...e){var t;(t=this.eventHandlers[o])==null||t.call(this,...e)}}class $ extends H{constructor(e,t,l={},d=null){super();O(this,M);O(this,R);O(this,U);O(this,_);O(this,S);O(this,N);O(this,b);O(this,I);O(this,T);O(this,D);O(this,E);this.scene=e,this.camera=t,g(this,R,new q),g(this,_,null),g(this,S,0),g(this,N,100),g(this,b,null),this.setGpsOptions(l),g(this,I,null),g(this,T,0),g(this,D,0),g(this,E,d)}setProjection(e){g(this,R,e)}setGpsOptions(e={}){e.gpsMinDistance!==void 0&&g(this,S,e.gpsMinDistance),e.gpsMinAccuracy!==void 0&&g(this,N,e.gpsMinAccuracy)}async startGps(){if(r(this,E)){const t=await(await r(this,E).sendData("/gps/start",{gpsMinDistance:r(this,S),gpsMinAccuracy:r(this,N)})).json();g(this,D,t.session)}return r(this,b)===null?(g(this,b,navigator.geolocation.watchPosition(e=>{P(this,M,V).call(this,e)},e=>{this.emit("gpserror",e)},{enableHighAccuracy:!0})),!0):!1}stopGps(){return r(this,b)!==null?(navigator.geolocation.clearWatch(r(this,b)),g(this,b,null),!0):!1}fakeGps(e,t,l=null,d=0){l!==null&&this.setElevation(l),P(this,M,V).call(this,{coords:{longitude:e,latitude:t,accuracy:d}})}lonLatToWorldCoords(e,t){const l=r(this,R).project(e,t);if(r(this,I))l[0]-=r(this,I)[0],l[1]-=r(this,I)[1];else throw"No initial position determined";return[l[0],-l[1]]}add(e,t,l,d,v={}){var i;e.properties=v,P(this,M,k).call(this,e,t,l,d),this.scene.add(e),(i=r(this,E))==null||i.sendData("/object/new",{position:e.position,x:e.position.x,z:e.position.z,session:r(this,D),properties:v})}setElevation(e){this.camera.position.y=e}}R=new WeakMap,U=new WeakMap,_=new WeakMap,S=new WeakMap,N=new WeakMap,b=new WeakMap,I=new WeakMap,T=new WeakMap,D=new WeakMap,E=new WeakMap,M=new WeakSet,k=function(e,t,l,d){const v=this.lonLatToWorldCoords(t,l);d!==void 0&&(e.position.y=d),[e.position.x,e.position.z]=v},K=function(e,t){g(this,I,r(this,R).project(e,t))},V=function(e){var l,d,v;let t=Number.MAX_VALUE;Y(this,T)._++,(l=r(this,E))==null||l.sendData("/gps/new",{gpsCount:r(this,T),lat:e.coords.latitude,lon:e.coords.longitude,acc:e.coords.accuracy,session:r(this,D)}),e.coords.accuracy<=r(this,N)&&(r(this,_)===null?g(this,_,{latitude:e.coords.latitude,longitude:e.coords.longitude}):t=P(this,M,J).call(this,r(this,_),e.coords),t>=r(this,S)&&(r(this,_).longitude=e.coords.longitude,r(this,_).latitude=e.coords.latitude,r(this,I)||(P(this,M,K).call(this,e.coords.longitude,e.coords.latitude),(d=r(this,E))==null||d.sendData("/worldorigin/new",{gpsCount:r(this,T),lat:e.coords.latitude,lon:e.coords.longitude,session:r(this,D),initialPosition:r(this,I)})),P(this,M,k).call(this,this.camera,e.coords.longitude,e.coords.latitude),(v=r(this,E))==null||v.sendData("/gps/accepted",{gpsCount:r(this,T),cameraX:this.camera.position.x,cameraZ:this.camera.position.z,session:r(this,D),distMoved:t}),this.emit("gpsupdate",{position:e,distMoved:t})))},J=function(e,t){const l=f.MathUtils.degToRad(t.longitude-e.longitude),d=f.MathUtils.degToRad(t.latitude-e.latitude),v=Math.sin(d/2)*Math.sin(d/2)+Math.cos(f.MathUtils.degToRad(e.latitude))*Math.cos(f.MathUtils.degToRad(t.latitude))*(Math.sin(l/2)*Math.sin(l/2));return 2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v))*6371e3};class tt extends H{constructor(o={},e){super(),this.sceneWebcam=new f.Scene;let t;if(e?t=document.querySelector(e):(t=document.createElement("video"),t.setAttribute("autoplay",!0),t.setAttribute("playsinline",!0),t.style.display="none",document.body.appendChild(t)),this.texture=new f.VideoTexture(t),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const l={video:{width:{ideal:o.idealWidth||1280},height:{ideal:o.idealHeight||720},facingMode:"environment"}};navigator.mediaDevices.getUserMedia(l).then(d=>{t.addEventListener("loadedmetadata",()=>{t.setAttribute("width",t.videoWidth),t.setAttribute("height",t.videoHeight),t.play(),this.emit("webcamstarted",{texture:this.texture})}),t.srcObject=d}).catch(d=>{this.emit("webcamerror",{code:d.name,message:d.message})})}else this.emit("webcamerror",{code:"LOCAR_NO_MEDIA_DEVICES_API",message:"Media devices API not supported"})}dispose(){this.texture.dispose()}}const j=navigator.userAgent.match(/iPhone|iPad|iPod/i)||/Macintosh/i.test(navigator.userAgent)&&navigator.maxTouchPoints!=null&&navigator.maxTouchPoints>1,et=new n.Vector3(0,0,1),z=new n.Euler,it=new n.Quaternion,nt=new n.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));class st extends n.EventDispatcher{constructor(o,e={}){super(),this.eventEmitter=new H;const t=this;this.object=o,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation=null,this.screenOrientation=0,this.alphaOffset=0,this.orientationOffset=0,this.initialOffset=null,this.lastCompassY=void 0,this.lastOrientation=null,this.TWO_PI=2*Math.PI,this.HALF_PI=.5*Math.PI,this.orientationChangeEventName="ondeviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation",console.log("Device Orientation Event Name:",this.orientationChangeEventName),this.smoothingFactor=e.smoothingFactor||1,this.enablePermissionDialog=e.enablePermissionDialog??!0;const l=function({alpha:i,beta:s,gamma:h,webkitCompassHeading:u}){if(j){const c=360-u;t.alphaOffset=n.MathUtils.degToRad(c-i),t.deviceOrientation={alpha:i,beta:s,gamma:h,webkitCompassHeading:u}}else i<0&&(i+=360),t.deviceOrientation={alpha:i,beta:s,gamma:h};window.dispatchEvent(new CustomEvent("camera-rotation-change",{detail:{cameraRotation:o.rotation}}))},d=function(){t.screenOrientation=window.orientation||0,j&&(t.screenOrientation===90?t.orientationOffset=-t.HALF_PI:t.screenOrientation===-90?t.orientationOffset=t.HALF_PI:t.orientationOffset=0)},v=function(i,s,h,u,c){z.set(h,s,-u,"YXZ"),i.setFromEuler(z),i.multiply(nt),i.multiply(it.setFromAxisAngle(et,-c))};this.connect=function(){d(),window.addEventListener("orientationchange",d),window.addEventListener(t.orientationChangeEventName,l),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",d),window.removeEventListener(t.orientationChangeEventName,l),t.enabled=!1,t.initialOffset=!1,t.deviceOrientation=null},this.requestOrientationPermissions=function(){window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?this.eventEmitter.emit("deviceorientationgranted",{target:this}):this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_PERMISSION_DENIED",message:"Permission for device orientation denied - AR will not work correctly"})}).catch(function(i){this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_PERMISSION_FAILED",message:"Permission request for device orientation failed - AR will not work correctly"})}):this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_INTERNAL_ERROR",message:"Internal error: no requestPermission() found although requestOrientationPermissions() was called - please raise an issue on GitHub"})},this.update=function({theta:i=0}={theta:0}){if(t.enabled===!1)return;const s=t.deviceOrientation;if(s){let h=s.alpha?n.MathUtils.degToRad(s.alpha)+t.alphaOffset:0,u=s.beta?n.MathUtils.degToRad(s.beta):0,c=s.gamma?n.MathUtils.degToRad(s.gamma):0;const L=t.screenOrientation?n.MathUtils.degToRad(t.screenOrientation):0;if(t.smoothingFactor<1){if(t.lastOrientation){const p=t.smoothingFactor;h=t._getSmoothedAngle(h,t.lastOrientation.alpha,p),u=t._getSmoothedAngle(u+Math.PI,t.lastOrientation.beta,p),c=t._getSmoothedAngle(c+t.HALF_PI,t.lastOrientation.gamma,p,Math.PI)}else u+=Math.PI,c+=t.HALF_PI;t.lastOrientation={alpha:h,beta:u,gamma:c}}if(j){const p=new n.Quaternion;v(p,h,t.smoothingFactor<1?u-Math.PI:u,t.smoothingFactor<1?c-Math.PI/2:c,L);const C=new n.Euler().setFromQuaternion(p,"YXZ");let F=n.MathUtils.degToRad(360-s.webkitCompassHeading);t.smoothingFactor<1&&t.lastCompassY!==void 0&&(F=t._getSmoothedAngle(F,t.lastCompassY,t.smoothingFactor)),t.lastCompassY=F,C.y=F+(t.orientationOffset||0),p.setFromEuler(C),t.object.quaternion.copy(p)}else v(t.object.quaternion,j?h+t.alphaOffset:h,t.smoothingFactor<1?u-Math.PI:u,t.smoothingFactor<1?c-Math.PI/2:c,L)}},this.getCorrectedHeading=function(){const{deviceOrientation:i}=t;if(!i)return 0;let s=0;return j?(s=360-i.webkitCompassHeading,t.orientationOffset&&(s+=t.orientationOffset*(180/Math.PI),s=(s+360)%360)):(i.absolute===!0||t.orientationChangeEventName,s=i.alpha?i.alpha:0,s=(360-s)%360,s<0&&(s+=360)),s},this._orderAngle=function(i,s,h=t.TWO_PI){return s>i&&Math.abs(s-i)<h/2||i>s&&Math.abs(s-i)>h/2?{left:i,right:s}:{left:s,right:i}},this._getSmoothedAngle=function(i,s,h,u=t.TWO_PI){const c=t._orderAngle(i,s,u),L=c.left,p=c.right;c.left=0,c.right-=L,c.right<0&&(c.right+=u);let C=p==s?(1-h)*c.right+h*c.left:h*c.right+(1-h)*c.left;return C+=L,C>=u&&(C-=u),C},this.updateAlphaOffset=function(){t.initialOffset=!1},this.dispose=function(){t.disconnect()},this.getAlpha=function(){const{deviceOrientation:i}=t;return i&&i.alpha?n.MathUtils.degToRad(i.alpha)+t.alphaOffset:0},this.getBeta=function(){const{deviceOrientation:i}=t;return i&&i.beta?n.MathUtils.degToRad(i.beta):0},this.getGamma=function(){const{deviceOrientation:i}=t;return i&&i.gamma?n.MathUtils.degToRad(i.gamma):0},this.obtainPermissionGesture=function(){const i=document.createElement("div"),s=document.createElement("div"),h=document.createElement("div"),u=document.createElement("div");document.body.appendChild(i);const c={display:"flex",position:"fixed",top:0,left:0,width:"100%",height:"100%",zIndex:1,backgroundColor:"rgba(0,0,0,0.6)",justifyContent:"center",alignItems:"center"},L={backgroundColor:"white",padding:"6px",borderRadius:"3px",width:"36rem",height:"24rem"},p={width:"100%",height:"70%",display:"flex",justifyContent:"center",alignItems:"center"},C={display:"inline-flex",width:"100%",height:"30%",justifyContent:"center",alignItems:"center"};for(let y in c)i.style[y]=c[y];for(let y in L)s.style[y]=L[y];for(let y in p)h.style[y]=p[y];for(let y in C)u.style[y]=C[y];i.appendChild(s),s.appendChild(h),s.appendChild(u),h.innerHTML='<div style="font-size: 24pt; margin: 1rem;">This immersive website requires access to your device motion sensors.</div>';const F=()=>{this.requestOrientationPermissions(),i.style.display="none"},x=document.createElement("button");x.addEventListener("click",F),x.style.width="50%",x.style.height="80%",x.style.fontSize="20pt",x.appendChild(document.createTextNode("OK")),u.appendChild(x),document.body.appendChild(i)}}on(o,e){this.eventEmitter.on(o,e)}init(){window.DeviceOrientationEvent===void 0?this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_NOT_SUPPORTED",message:"Device orientation API not supported"}):window.isSecureContext===!1?this.eventEmitter.emit("deviceorientationerror",{code:"LOCAR_DEVICE_ORIENTATION_NO_HTTPS",message:"DeviceOrientationEvent is only available in secure contexts (https)"}):typeof window.DeviceOrientationEvent.requestPermission=="function"&&this.enablePermissionDialog?this.obtainPermissionGesture():this.eventEmitter.emit("deviceorientationgranted",{target:this})}}class ot{constructor(o){this.raycaster=new f.Raycaster,this.normalisedMousePosition=new f.Vector2(null,null),o.domElement.addEventListener("click",e=>{this.normalisedMousePosition.set(e.clientX/o.domElement.clientWidth*2-1,-(e.clientY/o.domElement.clientHeight*2)+1)})}raycast(o,e){if(this.normalisedMousePosition.x!==null&&this.normalisedMousePosition.y!==null){this.raycaster.setFromCamera(this.normalisedMousePosition,o);const t=this.raycaster.intersectObjects(e.children,!1);return this.normalisedMousePosition.set(null,null),t}return[]}}const at="0.0.13-pre3";a.ClickHandler=ot,a.DeviceOrientationControls=st,a.EventEmitter=H,a.LocationBased=$,a.SphMercProjection=q,a.Webcam=tt,a.version=at,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
